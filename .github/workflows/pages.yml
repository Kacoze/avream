name: Pages

on:
  push:
    branches: ["main"]
    paths:
      - "site/**"
      - ".github/workflows/pages.yml"
      - "README.md"
      - "docs/**"
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Pages
        id: configure_pages
        continue-on-error: true
        uses: actions/configure-pages@v5

      - name: Generate latest release manifest
        if: steps.configure_pages.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 - <<'PY'
          from __future__ import annotations

          import json
          import os
          import pathlib
          import re
          import urllib.error
          import urllib.request

          repo = "${{ github.repository }}"
          url = f"https://api.github.com/repos/{repo}/releases/latest"
          headers = {
              "Accept": "application/vnd.github+json",
              "User-Agent": "avream-pages-workflow",
          }
          token = os.getenv("GITHUB_TOKEN")
          if token:
              headers["Authorization"] = f"Bearer {token}"

          fallback = {
              "version": "latest",
              "release_url": f"https://github.com/{repo}/releases/latest",
              "assets": {
                  "monolith": "",
                  "daemon": "",
                  "ui": "",
                  "helper": "",
                  "meta": "",
                  "deb_split_archive": "",
              },
          }

          def pick(assets: list[dict], pattern: str) -> str:
              for a in assets:
                  name = a.get("name", "")
                  if re.fullmatch(pattern, name):
                      return a.get("browser_download_url", "")
              return ""

          manifest = fallback
          try:
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req, timeout=20) as resp:
                  payload = json.load(resp)

              tag = str(payload.get("tag_name", "")).strip()
              version = tag[1:] if tag.startswith("v") else (tag or "latest")
              assets = payload.get("assets", []) if isinstance(payload.get("assets"), list) else []
              manifest = {
                  "version": version,
                  "release_url": payload.get("html_url") or fallback["release_url"],
                  "assets": {
                      "monolith": pick(assets, rf"avream_{re.escape(version)}_amd64\\.deb"),
                      "daemon": pick(assets, rf"avream-daemon_{re.escape(version)}_amd64\\.deb"),
                      "ui": pick(assets, rf"avream-ui_{re.escape(version)}_amd64\\.deb"),
                      "helper": pick(assets, rf"avream-helper_{re.escape(version)}_amd64\\.deb"),
                      "meta": pick(assets, rf"avream-meta_{re.escape(version)}_amd64\\.deb"),
                      "deb_split_archive": pick(assets, rf"avream-deb-split_{re.escape(version)}_amd64\\.tar\\.gz"),
                  },
              }
          except urllib.error.URLError as exc:
              print(f"Warning: could not fetch latest release metadata: {exc}")

          out = pathlib.Path("site/release-manifest.json")
          out.write_text(json.dumps(manifest, indent=2) + "\n", encoding="utf-8")
          print(out.read_text(encoding="utf-8"))
          PY

      - name: Upload site artifact
        if: steps.configure_pages.outcome == 'success'
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Pages not available notice
        if: steps.configure_pages.outcome != 'success'
        run: |
          echo "GitHub Pages is not enabled or not available for this repository plan."
          echo "Workflow finished without deployment."

      - name: Deploy to GitHub Pages
        if: steps.configure_pages.outcome == 'success'
        id: deployment
        uses: actions/deploy-pages@v4
